#!/usr/bin/env bash

set -o errexit

USAGE="Usage: $0 <namespace> <stage>"

if [[ -z "$1" || -z "$2" ]]; then
    echo "$USAGE"
    exit 1
fi

NAMESPACE=$1
STAGE=$2


CLIENT=${NAMESPACE:$(expr index $NAMESPACE -)}
USER=${NAMESPACE%-$CLIENT}
LIMIT_GROUP=${STAGE}-${CLIENT}

cd ~/esv/repos/build
git pull
helm repo update
kubectl create namespace $NAMESPACE
./deploy-to-cluster.sh $LIMIT_GROUP configuration/${CLIENT}-config
helm upgrade \
    --install \
    --namespace $NAMESPACE \
    --recreate-pods \
    $NAMESPACE-hdfs energysavvy/hdfs

